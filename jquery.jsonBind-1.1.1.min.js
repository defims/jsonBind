(function($){$.fn.extend({jsonBind:function(param,options,callback){$.isFunction(options)?callback=options:"";options=jQuery.extend({templatePattern:/data-template=["']([^"']+)["']/gim,innerTemplatePattern:/data-template-in=["']([^"']+)["']/gim,attributePattern:/data-attr-(\w+)=["']([^"']+)["']/gim,attributeValuePattern:/{([^"'{}]+)}/gim,elementPattern:/<!--(\w+)-->/gim,serialPattern:/serial/im,hideTemplate:true,hideDataPath:true,debug:false},options);var targetDom=$(this);if(targetDom.length){if(typeof(param)=="string"){var scriptDom=document.createElement("SCRIPT");scriptDom.id="jsonBindTempDom";scriptDom.src=param;scriptDom.type="text/javascript";scriptDom.onload=scriptDom.onreadystatechange=function(){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){fnInit(targetDom,data);scriptDom.onload=scriptDom.onreadystatechange=null}};document.getElementsByTagName("HEAD")[0].appendChild(scriptDom)}else{fnInit(targetDom,param)}}function fnInit(targetDom,data){var attr=targetDom.attr("data-template")?targetDom.attr("data-template"):targetDom.attr("data-template-in");if(attr=="root"||attr=="template"){var useData=data;var dataPath=""}else{var useData=data[attr];var dataPath=attr}if(callback){callback.call(targetDom,fnRender(targetDom,useData,dataPath),data)}else{targetDom.after(fnRender(targetDom,useData,dataPath))}if(options.hideTemplate){targetDom.hide()}}function fnRender(template,data,path){var templateDom=$(template).clone().empty();if(Object.prototype.toString.apply(data).split("object ")[1].split("]")[0]=="Object"){data=new Array(data)}var serialNum=0;for(var index=0;index<data.length;++index){var renderTemp=$(template).clone();renderTemp.find("[data-template],[data-template-in]").replaceWith(function(){var attr=$(this).attr("data-template")?$(this).attr("data-template"):$(this).attr("data-template-in");var dataTemp=data[index][attr];if(dataTemp){var content=fnRender($(this),dataTemp,path+"["+index+"]."+attr)}return content?content:""});if(template.attr("data-template-in")){templateDom.append($(fnTemplateReplace()).html())}else{templateDom.append(fnTemplateReplace())}function fnTemplateReplace(){return renderTemp.wrap("<div/>").parent().html().replace(options.elementPattern,function(o,i){if(options.serialPattern.test(i)){return serialNum++}else{return data[index][i]?data[index][i]:""}}).replace(options.templatePattern,function(m,value){return options.hideDataPath?"":"data-path='"+(path+"["+index+"]")+"'"}).replace(options.attributePattern,function(m,attr,value){value=value.replace(options.attributeValuePattern,function(){for(var i=1;i<arguments.length-2;++i){if(options.serialPattern.test(arguments[i])){return serialNum++}else{return data[index][arguments[i]]?data[index][arguments[i]]:""}}});return value?attr+"='"+value+"'":""})}}$("#jsonBindTempDom").remove();data=null;return template.attr("data-template")?templateDom.html():templateDom.wrap("<div/>").parent().html()}}})})(jQuery);
